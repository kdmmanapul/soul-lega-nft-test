<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="icon/icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon/icon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="./register.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.14.1/css/mdb.min.css" rel="stylesheet">
  <title>Soul Legacy Online</title>
</head>
<body style="margin:0;padding:0;">
  <div class="overlay"></div>
  <div class="container">
    <div class="row register_row">
    
      <div class="col s12" style="float: none; margin: 0 auto; box-sizing: border-box;">
        <div class="card" style="margin: 0;">
          <!-- <div class="card-image">
            <div style="width: 100%; height: 150px; overflow: hidden;">
              <img src="./img/parallaxes/TwitterBanner.png">
            </div>
          </div> -->
          <div class="card-content" style="padding-bottom: 4px; width: 1000px;">
            <div id="instructionsZone" class="row">
              <div class="col s12">
                <div style="text-align: left;">
                  <p>You can register for an account to play the demo if you have a Soul Legacy NFT or an OG role in discord. </p>
                  <p>1. Connect your Wallet</p>
                  <p>2. Load Soul Legacy NFTs</p>
                  <p>3. Register Account</p>
                  <!-- <h2>Coming Soon...</h2> -->
                </div>
              </div>
            </div>
            <!-- START -->
            <main class="p-10 flex justify-center min-h-full container">
              <div style="justify-content: center; display: flex; margin-bottom: 30px;">
                <button id="enableEthereumButton" style="width: 200px;" class="btn waves-effect waves-light">Connect Wallet</button>
                <h2>Account: <span id="wallet_address" class="showAccount"></span></h2>
              </div>
              
              <div class="w-4/5">
                <div class="mb-10" style="justify-content: center; text-align: center;">
                  <button id="load_button"  class="border-2 border-blue-500 bg-blue-700 text-white transition-colors px-4 outline-none py-1 uppercase rounded-md text-xl font-semibold">
                    Load Soul Legacy Legends NFTs
                  </button>
                </div>
          
                <div id="nfts" class="flex gap-7 flex-wrap"></div>
                <p id="total-balance" style="margin-top: 1rem;"></p>
              </div>
              <template id="nft_template">
                <section>
                  <p class="font-bold bg-yellow-500 text-white text-center rounded-t-md"></p>
            
                  <a href="" target="_blank">
                    <img style="width: 120px; height: 120px; margin: 5;" src="" alt="">>
                  </a>
                </section>
              </template>
            </main>
            <!-- STOP -->
            <div id="formRegister">
              <!-- <li id="allfieldsrequired" style="color: black;">All fields are required</li>
              <li id="usernameformat" style="color: black;">Username will be the first 10 digits of your Wallet's Address </li>
              <div id="inputsZone" class="row">
                <form class="col s12">
                  <div class="row">
                    <div class="input-field col s6">
                      <input id="username" type="text" class="validate" disabled>
                    </div>
                    <div class="input-field col s6">
                      <input id="password" type="password" class="validate">
                      <label for="password">Password</label>
                    </div>
                  </div>
                </form>
              </div>
              <div id="serverResponseZone" style="color: red; margin:8px; text-align: center;" class="row"></div> -->
            </div>
          </div>
          
          <div class="card-action">
            <div class="row" style="margin:0;">
              <div class="col xs12 m6">
                <a onclick="window.close()" class="blue-text" style="cursor:pointer; line-height: 36px;">Close</a>
              </div>
              <div class="col xs12 m6" style="text-align: right;">
                <button type="button" onclick="location.href='https://discord.gg/soullegacy'" class="btn waves-effect waves-light">Discord</button>
                <button id="registerBtn"  class="btn waves-effect waves-light">Register</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Please : Set your own server on line 103 -->


  <script type="text/javascript" src="./js/libs/materialize.min.js"></script>
  <script type="text/javascript" src="./js/libs/socket.io.js"></script>

  <script>
    // Select the form inputs :
    const userField = document.getElementById('username');
    const passField = document.getElementById('password');
    const registerBtn = document.getElementById('registerBtn');
    let isFormValid = false; // declare a boolean to true to remember if the form datas are correct

    const checkInputs = () => {
      // This function will test the username format (from 4 to 25 alphanumeric characters)
      function isValidUsername(string) {
        return /^(?=[a-zA-Z0-9\s]{4,25}$)(?=[a-zA-Z0-9\s])(?:([\w\s*?])\1?(?!\1))+$/.test(string);
      }
      const userField = document.getElementById('username');
      const passField = document.getElementById('password');
      const registerBtn = document.getElementById('registerBtn');
      isFormValid = true; // We first say the form is valid
      // Then if it's not, do the followings : 
      if (!userField || !userField.value || !isValidUsername(userField.value) ) { // No username or not valid
        isFormValid = false;
        document.getElementById('usernameformat').style.color = 'red';
      } else {
        document.getElementById('usernameformat').style.color = 'black';
      }
      if (!passField || !passField.value || passField.value.length < 1) { // No password
        isFormValid = false;
        document.getElementById('allfieldsrequired').style.color = 'red';
      } else {
        document.getElementById('allfieldsrequired').style.color = 'black';
      }

      registerBtn.disabled = !isFormValid; // If form is not valid, disable Register button.
    };
    
    const register = (username,password) => {
      const domain = 'https://server.soullegacy.online:8097'; // TODO : Set your own server (domain name + port, ex : http://mynew.mmo:8097/ )
      const socket = io.connect(domain);
      // Setting up UI behavior : 
      socket.on('login_error', (data,callback) => { // Display UI error when server returns any
        if (data) {
          document.getElementById('serverResponseZone').innerHTML = data.msg;
          document.getElementById('serverResponseZone').style.color = "red";
        }
      });
      socket.on('register_success', (data,callback) => { // On succes, just display the success msg from backend
        if (data) {
          document.getElementById('serverResponseZone').innerHTML = data.msg;
          document.getElementById('serverResponseZone').style.color = "green";
          document.getElementById('instructionsZone').style.display = 'none';
          document.getElementById('inputsZone').style.display = 'none';
          registerBtn.style.display = 'none';
        }
      });
      // Run the registration, passing username and password as payload. 
      socket.emit('register', {username, password});
    };

    // const init = () => {
      registerBtn.addEventListener('click', (e) => { // On Registration btn press.
        checkInputs(); // Check the inputs one last time
        const userField = document.getElementById('username');
        const passField = document.getElementById('password');
        if (isFormValid) {
          // if everything went fine, run the register function.
          register(userField.value,passField.value)
        }
      });

      // Check inputs validity whenever the user types anything
      // userField.addEventListener('keyup', () => checkInputs());
      // passField.addEventListener('keyup', () => checkInputs());
    // };

    // init();
  </script>
  <!-- Metamask Integration -->
  <script>
    const ethereumButton = document.getElementById('enableEthereumButton');
    const showAccount = document.querySelector('.showAccount');
    const user = document.getElementById('username');
    ethereumButton.addEventListener('click', () => {
      //Will Start the metamask extension
      getAccount();
      document.getElementById('enableEthereumButton').style.display = 'none';
    });
    async function getAccount() {
      const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
      const account = accounts[0];
      showAccount.innerHTML = account;
      // user.value = account.substring(0,10);
    }
  </script>

  <script src="node_modules/@metamask/onboarding/dist/metamask-onboarding.bundle.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.0-rc.0/web3.min.js"></script>
  <script type="module" src="register.js"></script>
</body>
</html>